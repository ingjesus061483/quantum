@model Factory.FacturaEncabezado

@{
    ViewBag.Title = "Facturar compra";
    string url = ViewBag.url;
    List<Factory.FacturaDetalle> detalles = ViewBag.detalles;
    decimal totalpagar = 0;
    if (ViewBag.totalPagar != null)
    {
         totalpagar = ViewBag.totalPagar;
    }
}

<h2>@ViewBag.Title</h2>   
    <div class="card">
        <div class="header">Encabezado</div>
        <div class="body">
            @using (Html.BeginForm())
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <div style="padding:20px;">
                    <label>Identificacion cliente</label>
                    <input type="text" id="identificacion" required="required" class="form-control" style="width :100%" />
                    <button id="btnBuscar" class="button">Buscar</button>
                    <input type="hidden" id="cadena" name="cadena" />
                </div>                
                <div style="padding:20px;">
                    @Html.LabelFor(model => model.FechaVenta)
                    @Html.EditorFor(model => model.FechaVenta, new { htmlAttributes = new { @type = "datetime", @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.FechaVenta, "", new { @class = "text-danger" })
                </div>
                <div style="padding:20px">
                    @Html.LabelFor(model => model.FechaEnvio)
                    @Html.EditorFor(model => model.FechaEnvio, new { htmlAttributes = new { @type = "datetime", @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.FechaEnvio, "", new { @class = "text-danger" })
                </div>
                <div style="padding:20px">
                    <input id="btnCrear" type="submit" value="Enviar" style="width:100% ;display:none;" class="button" />
                </div>
            }
        </div>
    </div>

    <h4> detalle</h4>
    <table class="table">
        <tr>
            <th>cantidad</th>
            <th> producto </th>
            <th>  valor Unitario </th>
            <th> total  </th>
        </tr>
        <tbody>
            @foreach (var item in detalles)
            {
                <tr>
                    <td>@item.cantidad  </td>
                    <td>@item.producto.Nombre </td>
                    <td>@item.ValorUnitarioIva   </td>
                    <td>@item.totalIva  </td>
                </tr>
            }
        </tbody>
    </table>
    <div style="padding:20px;">
        <label>total a pagar :</label>@totalpagar
    </div>
    <div style="padding :20px">
        @Html.ActionLink("Regresar a productos", "Index","Productos", null, htmlAttributes: new { @class = "button" })
    </div>
    <div id="resp" style="display:none;">
        
    </div>
    <div id="dialog" style=" display:none ;padding :30px">
        <form>
            <div class="form-group">
                <label> Nombre</label>
                <input class="form-control" type="text" id="nombre" style=" width:100%" />
            </div>
            <div class="form-group">
                <label>Apellido</label>
                <input type="text" class="form-control" id="apellido" style=" width:100%" />
            </div>
            <div class="form-group">
                <label> Direccion </label>
                <input type="text" id="direccion" class="form-control" style=" width:100%" />
            </div>
            <div class="form-group">
                <label>Telefono</label>
                <input type="text" class="form-control" id="telefono" style=" width:100%" />
            </div>
        </form>
    </div>

    @section Scripts {
        @Scripts.Render("~/bundles/jqueryval")
        <script type="text/javascript">
            $('input[type=datetime]').datepicker({
                dateFormat: "dd/MM/yy",
                changeMonth: true,
                changeYear: true,
                yearRange: "-60:+0"
            });
            function guardar()
            {
                identificacion = $("#identificacion").val();
                nombre = $("#nombre").val();
                apellido = $("#apellido").val();
                direccion = $("#direccion").val();
                telefono = $("#telefono").val();
                if (identificacion == "") {
                    alertify.error("campo invalido");
                    return;
                }
                if (nombre == "") {
                    alertify.error("camppo invalido");
                    return;
                }
                if (apellido == "") {
                    alertify.error("campo invalido");
                    return;
                }
                if (direccion == "") {
                    alertify.error("campo invalido");
                    return;
                }
                if (telefono == "") {
                    alertify.error("campo invalido");
                    return;
                }
                $.ajax({
                    data: { identificacion: identificacion, nombre: nombre, apellido: apellido, direccion: direccion, telefono: telefono },
                    dataType: 'json',
                    type: "POST",
                    url: "@url/Clientes"
                }).done(function (data, textStatus, jqXHR) {
                    var enconded = JSON.stringify(data);
                    console.log("estado :", textStatus);
                    $("#cadena").val(enconded)
                    alertify.success("el registro seha insertado con exito")
                    console.log("La solicitud se ha completado correctamente.", enconded);
                    $("#btnCrear").fadeIn()
                    $("#dialog").dialog("close");
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    $("#dialog").dialog("open");
                    console.log("La solicitud a fallado: ", textStatus);
                });
            }
            $("#dialog").dialog({
                autoOpen: false,
                height: 500,
                width: 350,
                buttons: {
                    "Guardar": function () { guardar() },
                },
                modal: true
            });
            $("#resp").dialog({
                autoOpen: false,
                height: 500,
                width: 350,
                buttons: {
                    "cerrar": function () { $(this).dialog("close") },                    
                },
                modal: true
            });


    $("#btnBuscar").click(function () {
        var identificacion = $("#identificacion").val();
        if (identificacion == "") {
            alertify.error("este campo no puede ser vacio");
            return;
        }
        $.ajax({
            data: { identificacion: identificacion },
            dataType: 'json',
            type: "GET",
            url:  "@url/Clientes"
        }).done(function (data, textStatus, jqXHR) {
            if (data == null) {
                $("#cadena").val("");            
                $("#dialog").dialog("open");
                $("#btnCrear").fadeOut()                
            }
            else
            {
                console.log("estado :", textStatus);
                console.log("estado :", textStatus);
                var enconded = JSON.stringify(data);
                var content = "<p><b>Nombre:</b>" + data.nombreCompleto + "</p><p><b>Direccion:</b>" + data.Direccion + "</p><p><b>Telefoo: </b>" + data.Telefono + "</p>";
                $("#resp").html(content);
                $("#resp").dialog("open");
                $("#cadena").val(enconded);
                alertify.success("se ha encontrado un cliente");
                $("#btnCrear").fadeIn()
                console.log("La solicitud se ha completado correctamente.", enconded);
                console.log("La solicitud se ha completado correctamente.", data);
            }
        }).fail(function (jqXHR, textStatus, errorThrown) {
            $("#cadena").val("");
            $("#dialog").dialog("open");
            console.log("La solicitud a fallado: ", textStatus);
        });
    })
        </script>
    }
